<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Project Task Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Karla:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f1f5f2;
      --ink: #122016;
      --muted: #5a6a5e;
      --header: #1f5c43;
      --header-2: #1a4d38;
      --line: #d3dfd6;
      --card: #ffffff;
      --accent: #0f7a5b;
      --accent-soft: rgba(15, 122, 91, 0.14);
      --shadow: 0 16px 40px rgba(9, 24, 16, 0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background:
        radial-gradient(circle at 0% 0%, rgba(31, 92, 67, 0.18), transparent 40%),
        radial-gradient(circle at 100% 0%, rgba(143, 188, 165, 0.28), transparent 45%),
        linear-gradient(135deg, #f8fbf9 0%, #eef4f0 100%);
      font-family: "Karla", system-ui, -apple-system, sans-serif;
      color: var(--ink);
      overflow-x: hidden;
    }

    .wrap {
      padding: 28px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }

    .title h1 {
      font-family: "Playfair Display", serif;
      font-weight: 700;
      font-size: 30px;
      margin: 0;
      letter-spacing: 0.4px;
    }

    .subtitle {
      color: var(--muted);
      font-size: 13px;
      margin-top: 4px;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .pill {
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 13px;
      color: #1b2a1f;
      background: #e8f1ec;
      border: 1px solid #c9d8cf;
    }

    .pill.alert {
      background: #ffe7e7;
      border-color: #f3b7b7;
      color: #8b1d1d;
    }

    .controls {
      display: grid;
      grid-template-columns: 1.6fr 1fr 1fr 1fr auto;
      gap: 10px;
      margin-bottom: 14px;
      background: rgba(255,255,255,0.75);
      border: 1px solid #d9e4dd;
      padding: 12px;
      border-radius: 14px;
      box-shadow: 0 10px 24px rgba(9, 24, 16, 0.08);
      backdrop-filter: blur(8px);
    }

    .controls input,
    .controls select,
    .controls button {
      padding: 9px 10px;
      border-radius: 10px;
      border: 1px solid #cfd9cf;
      font-size: 13px;
      background: #fff;
      font-family: inherit;
    }

    .controls button {
      background: var(--accent);
      color: white;
      border: none;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .controls button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    }

    .table-wrap {
      background: var(--card);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: var(--shadow);
      border: 1px solid var(--line);
    }

    .table-scroll {
      overflow-x: auto;
      overflow-y: visible;
      scrollbar-gutter: stable both-edges;
      max-width: 100%;
      scrollbar-color: #8fbca5 #e9f1ec;
      scrollbar-width: thin;
    }
    .table-scroll::-webkit-scrollbar {
      height: 12px;
    }
    .table-scroll::-webkit-scrollbar-track {
      background: #e9f1ec;
      border-radius: 999px;
      margin: 0 12px;
    }
    .table-scroll::-webkit-scrollbar-thumb {
      background: linear-gradient(90deg, #7fb198, #5c9c7c);
      border-radius: 999px;
      border: 2px solid #e9f1ec;
    }

    table {
      width: max-content;
      min-width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    thead th {
      background: linear-gradient(0deg, var(--header), var(--header-2));
      color: #f6fff8;
      font-weight: 600;
      text-align: left;
      padding: 12px 10px;
      position: sticky;
      top: 0;
      z-index: 2;
      border-right: 1px solid rgba(255,255,255,0.15);
      letter-spacing: 0.2px;
    }

    thead th:last-child { border-right: none; }

    .sticky-actions {
      position: sticky;
      right: 0;
      z-index: 3;
      background: linear-gradient(0deg, var(--header), var(--header-2));
      box-shadow: -10px 0 18px rgba(0,0,0,0.12);
    }

    tbody td {
      padding: 8px 10px;
      vertical-align: top;
      border-bottom: 1px solid #edf0ea;
    }

    tbody td.sticky-actions {
      background: #ffffff;
      z-index: 2;
      box-shadow: -10px 0 18px rgba(0,0,0,0.08);
    }

    tbody tr:nth-child(even) {
      background: #fafbf8;
    }

    .id {
      font-weight: 700;
      color: #2e3a2f;
      white-space: nowrap;
    }

    .deadline-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      margin-left: 6px;
      background: #ffe7e7;
      color: #8b1d1d;
      border: 1px solid #f3b7b7;
      white-space: nowrap;
    }

    .due-soon {
      background: #fff0d6;
      color: #9c5a00;
      border-color: #f2d2a6;
    }

    .row-overdue {
      background: #fff5f5 !important;
    }

    .row-due-soon {
      background: #fffbf2 !important;
    }
    .desc {
      min-width: 320px;
      color: #2f3a30;
      line-height: 1.35;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      white-space: normal;
      max-width: 140px;
      line-height: 1.2;
      text-align: center;
      border: 1px solid transparent;
    }

    .chip.blue { background: #e1ecfb; color: #1f5ea8; border-color: #cfe1fa; }
    .chip.red { background: #ffe1e1; color: #9b1010; border-color: #f7b9b9; }
    .chip.green { background: #dff2e5; color: #1f6a36; border-color: #c3e4cd; }
    .chip.orange { background: #fde9d0; color: #a95b12; border-color: #f3d0a3; }
    .chip.gray { background: #e7ece8; color: #55625a; border-color: #d6ddd7; }
    .chip.mint { background: #cce7db; color: #275e4c; }
    .chip.lilac { background: #d7c7f1; color: #4b2a7a; }
    .chip.salmon { background: #f3b7b7; color: #7a1e1e; }
    .chip.sand { background: #efe7d2; color: #6f5a2d; }

    .chip-select {
      border: 1px solid transparent;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 600;
      appearance: none;
      background: #fff;
      cursor: pointer;
      font-family: inherit;
      white-space: normal;
      max-width: 140px;
    }

    .input-field {
      width: 100%;
      border: 1px solid #cfd9cf;
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 12px;
      font-family: inherit;
      background: #fffdf5;
    }

    .input-field:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(240, 201, 135, 0.4);
      border-color: #f0c987;
    }

    .chip-select:disabled {
      cursor: default;
      opacity: 0.8;
    }

    .chip-select.blue { background: #e1ecfb; color: #1f5ea8; border-color: #cfe1fa; }
    .chip-select.red { background: #ffe1e1; color: #9b1010; border-color: #f7b9b9; }
    .chip-select.green { background: #dff2e5; color: #1f6a36; border-color: #c3e4cd; }
    .chip-select.orange { background: #fde9d0; color: #a95b12; border-color: #f3d0a3; }
    .chip-select.gray { background: #e7ece8; color: #55625a; border-color: #d6ddd7; }
    .chip-select.mint { background: #cce7db; color: #275e4c; }
    .chip-select.lilac { background: #d7c7f1; color: #4b2a7a; }
    .chip-select.salmon { background: #f3b7b7; color: #7a1e1e; }
    .chip-select.sand { background: #efe7d2; color: #6f5a2d; }

    .editable {
      outline: none;
      border-radius: 6px;
      padding: 3px 4px;
      min-height: 18px;
    }

    .editable.readonly {
      background: transparent;
      padding: 0;
    }

    .editable:focus {
      background: #fff4d6;
      box-shadow: inset 0 0 0 1px #f0c987;
    }

    .actions {
      display: flex;
      gap: 6px;
    }

    .action-btn {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #cfd9cf;
      font-size: 12px;
      background: #fff;
      cursor: pointer;
      font-family: inherit;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .action-btn.primary {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .small {
      color: var(--muted);
      font-size: 12px;
    }

    .table-title {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #e7f1ec;
      padding: 10px 14px;
      border-bottom: 1px solid var(--line);
      font-weight: 600;
    }

    .table-title .tag {
      background: var(--accent);
      color: white;
      border-radius: 6px;
      padding: 2px 8px;
      font-size: 12px;
      font-weight: 700;
    }

    .legend {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      padding: 12px 14px;
      border-top: 1px solid var(--line);
      background: #fbfcfa;
    }

    .legend .chip { font-weight: 500; }

    .note {
      font-size: 12px;
      color: #6a746a;
      padding: 12px 14px;
      border-top: 1px dashed #d6ddd7;
      background: #fbfcfa;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(8, 20, 12, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 20px;
    }

    .modal.open { display: flex; }

    .modal-card {
      background: #ffffff;
      border-radius: 16px;
      max-width: 760px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
      border: 1px solid #dfe9e2;
      overflow: hidden;
    }

    .modal-header {
      padding: 16px 18px;
      background: #e7f1ec;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid #dbe6dd;
    }

    .modal-title {
      font-weight: 700;
      font-size: 16px;
    }

    .modal-body {
      padding: 16px 18px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .detail {
      background: #f6faf7;
      border: 1px solid #e4eee7;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 13px;
    }

    .detail span {
      display: block;
      color: #5f6d63;
      font-size: 11px;
      margin-bottom: 4px;
    }

    .modal-footer {
      padding: 12px 18px 16px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .compact .controls input,
    .compact .controls select,
    .compact .controls button {
      padding: 7px 8px;
      font-size: 12px;
    }

    .compact table { font-size: 12px; }
    .compact tbody td { padding: 6px 8px; }
    .compact .desc { line-height: 1.25; }
    .compact .action-btn { padding: 5px 8px; font-size: 11px; }
    .compact .chip,
    .compact .chip-select { font-size: 11px; padding: 3px 8px; }

    @media (max-width: 980px) {
      .wrap { padding: 16px; }
      .desc { min-width: 200px; }
      .controls { grid-template-columns: 1fr; }
      table { font-size: 13px; }
      .actions { flex-direction: column; }
    }

    @media (max-width: 720px) {
      .table-wrap { overflow: visible; }
      .table-scroll { overflow-x: visible; }
      table, thead, tbody, th, td, tr { display: block; }
      thead { display: none; }
      .sticky-actions { position: static; box-shadow: none; background: transparent; }
      tbody tr {
        background: #fff;
        margin: 12px 10px;
        border-radius: 12px;
        box-shadow: 0 10px 24px rgba(0,0,0,0.06);
        overflow: hidden;
        border: 1px solid #e3eadf;
      }
      tbody tr:nth-child(even) { background: #fff; }
      tbody td {
        display: flex;
        gap: 10px;
        justify-content: space-between;
        align-items: flex-start;
        border-bottom: 1px solid #edf0ea;
        padding: 10px 12px;
      }
      tbody td:last-child { border-bottom: none; }
      tbody td::before {
        content: attr(data-label);
        font-weight: 600;
        color: #4b5a4b;
        min-width: 130px;
        max-width: 45%;
      }
      .desc { min-width: 0; }
      .actions { width: 100%; }
      .editable { width: 100%; }
      .chip-select { max-width: 100%; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <div>
        <h1>Project Task Tracker</h1>
        <div class="subtitle">Academic operations dashboard with live editing</div>
      </div>
      <div class="toolbar">
        <span class="pill" id="lastUpdated">Updated: Feb 03, 2026</span>
        <span class="pill" id="countPill">0 Tasks</span>
      </div>
    </div>

    <div class="controls">
      <input id="searchInput" type="search" placeholder="Search task name, description, remarks, or ID" />
      <select id="filterCategory">
        <option value="">All Categories</option>
      </select>
      <select id="filterPriority">
        <option value="">All Priorities</option>
      </select>
      <select id="filterStatus">
        <option value="">All Statuses</option>
      </select>
      <input id="filterStartDate" type="date" />
      <button id="compactToggle" type="button">Compact View: Off</button>
      <button id="resetBtn" type="button">Reload from Database</button>
    </div>

  <div class="table-wrap">
    <div class="table-title">
      <span class="tag">Project_Task_Tracker</span>
      <span class="small">Office & Academic Operations</span>
    </div>

      <div class="table-scroll">
        <table aria-label="Task system table">
          <thead>
            <tr>
              <th>Task ID</th>
              <th>Task Name</th>
              <th>Category</th>
              <th>Priority</th>
              <th>Status</th>
              <th class="sticky-actions">Actions</th>
            </tr>
          </thead>
          <tbody id="taskBody"></tbody>
        </table>
      </div>

      <div class="legend">
        <span class="chip blue">Priority: Can Wait</span>
        <span class="chip red">Priority: Urgent</span>
        <span class="chip green">Status: Done / Submitted</span>
        <span class="chip orange">Status: On Going</span>
        <span class="chip gray">Placeholder: New</span>
      </div>
    <div class="note">Click “Edit” to unlock a row, then “Save” to commit changes to the database.</div>
  </div>

  <div class="modal" id="detailModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
      <div class="modal-header">
        <div>
          <div class="modal-title" id="detailTitle">Task Details</div>
          <div class="small" id="detailSubtitle"></div>
        </div>
        <button class="action-btn" id="closeModalBtn" type="button">Close</button>
      </div>
      <div class="modal-body" id="detailBody"></div>
      <div class="modal-footer">
        <button class="action-btn" id="editModalBtn" type="button">Update Details</button>
        <button class="action-btn primary" id="saveModalBtn" type="button">Save Changes</button>
        <button class="action-btn" id="closeModalBtnBottom" type="button">Done</button>
      </div>
    </div>
  </div>
  </div>

  <script>
    const API_BASE = "/api/tasks";

    const categoryOptions = ["OSD", "SOA", "Capstone", "Program Coordinator", "Faculty", "new"];
    const priorityOptions = ["Can Wait", "Urgent", "New"];
    const statusOptions = ["Done", "Submitted", "On Going", "new"];

    const taskBody = document.getElementById("taskBody");
    const searchInput = document.getElementById("searchInput");
    const filterCategory = document.getElementById("filterCategory");
    const filterPriority = document.getElementById("filterPriority");
    const filterStatus = document.getElementById("filterStatus");
    const filterStartDate = document.getElementById("filterStartDate");
    const countPill = document.getElementById("countPill");
    const lastUpdated = document.getElementById("lastUpdated");
    const compactToggle = document.getElementById("compactToggle");
    const resetBtn = document.getElementById("resetBtn");
    const detailModal = document.getElementById("detailModal");
    const detailBody = document.getElementById("detailBody");
    const detailSubtitle = document.getElementById("detailSubtitle");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const closeModalBtnBottom = document.getElementById("closeModalBtnBottom");
    const editModalBtn = document.getElementById("editModalBtn");
    const saveModalBtn = document.getElementById("saveModalBtn");

    let tasks = [];
    let editingId = null;
    let newTask = createEmptyTask();
    let isCompact = false;
    let modalTask = null;
    let modalMode = "view";
    let deadlineStats = { overdue: 0, dueSoon: 0 };

    function setLastUpdated() {
      lastUpdated.textContent = `Updated: ${new Date().toLocaleDateString("en-US", { month: "short", day: "2-digit", year: "numeric" })}`;
    }

    function parseDate(value) {
      if (!value) return null;
      const parsed = new Date(value);
      if (Number.isNaN(parsed.getTime())) return null;
      return parsed;
    }

    function toDateInputValue(value) {
      const date = parseDate(value);
      if (!date) return "";
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function getDeadlineStatus(task) {
      const due = parseDate(task.due_date);
      if (!due) return "none";
      const statusText = String(task.status || "").toLowerCase();
      if (statusText.includes("done") || statusText.includes("submitted")) return "none";
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const dueDay = new Date(due);
      dueDay.setHours(0, 0, 0, 0);
      const diffDays = Math.round((dueDay - today) / 86400000);
      if (diffDays < 0) return "overdue";
      if (diffDays <= 2) return "due-soon";
      return "none";
    }

    function updateDeadlineStats(data) {
      deadlineStats = { overdue: 0, dueSoon: 0 };
      data.forEach((task) => {
        const status = getDeadlineStatus(task);
        if (status === "overdue") deadlineStats.overdue += 1;
        if (status === "due-soon") deadlineStats.dueSoon += 1;
      });
      const totalAlerts = deadlineStats.overdue + deadlineStats.dueSoon;
      if (totalAlerts > 0) {
        countPill.classList.add("alert");
        countPill.textContent = `${totalAlerts} Deadline Alert${totalAlerts > 1 ? "s" : ""}`;
      } else {
        countPill.classList.remove("alert");
        countPill.textContent = `${data.length} Tasks`;
      }
    }

    function applyCompactState() {
      document.body.classList.toggle("compact", isCompact);
      compactToggle.textContent = `Compact View: ${isCompact ? "On" : "Off"}`;
      localStorage.setItem("compactView", JSON.stringify(isCompact));
    }

    async function fetchTasks() {
      const response = await fetch(API_BASE);
      tasks = await response.json();
      refreshFilterOptions();
      applyFilters();
    }

    async function createTask(payload) {
      const response = await fetch(API_BASE, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!response.ok) throw new Error("Failed to create task");
      return response.json();
    }

    async function updateTask(id, payload) {
      const response = await fetch(`${API_BASE}/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!response.ok) throw new Error("Failed to update task");
      return response.json();
    }

    async function deleteTask(id) {
      const response = await fetch(`${API_BASE}/${id}`, { method: "DELETE" });
      if (!response.ok) throw new Error("Failed to delete task");
    }

    function createEmptyTask() {
      return {
        task_id: "",
        name: "",
        description: "",
        category: "new",
        priority: "New",
        status: "new",
        start_date: "",
        due_date: "",
        est_time: "",
        act_time: "",
        remarks: ""
      };
    }

    function resetSelect(select, placeholderText, selectedValue) {
      select.innerHTML = "";
      const base = document.createElement("option");
      base.value = "";
      base.textContent = placeholderText;
      select.append(base);
      if (selectedValue) base.selected = false;
    }

    function buildFilterOptions(select, options, selectedValue) {
      const unique = Array.from(new Set(options)).sort();
      for (const opt of unique) {
        const option = document.createElement("option");
        option.value = opt;
        option.textContent = opt;
        if (opt === selectedValue) option.selected = true;
        select.append(option);
      }
    }

    function refreshFilterOptions() {
      const selectedCategory = filterCategory.value;
      const selectedPriority = filterPriority.value;
      const selectedStatus = filterStatus.value;

      const categories = new Set(categoryOptions);
      const priorities = new Set(priorityOptions);
      const statuses = new Set(statusOptions);

      tasks.forEach((task) => {
        if (task.category) categories.add(task.category);
        if (task.priority) priorities.add(task.priority);
        if (task.status) statuses.add(task.status);
      });

      resetSelect(filterCategory, "All Categories", selectedCategory);
      buildFilterOptions(filterCategory, categories, selectedCategory);
      if (selectedCategory) filterCategory.value = selectedCategory;

      resetSelect(filterPriority, "All Priorities", selectedPriority);
      buildFilterOptions(filterPriority, priorities, selectedPriority);
      if (selectedPriority) filterPriority.value = selectedPriority;

      resetSelect(filterStatus, "All Statuses", selectedStatus);
      buildFilterOptions(filterStatus, statuses, selectedStatus);
      if (selectedStatus) filterStatus.value = selectedStatus;
    }

    function getChipClass(value, type) {
      const val = String(value || "").toLowerCase();
      if (type === "priority") {
        if (val.includes("urgent")) return "red";
        if (val.includes("can wait")) return "blue";
        return "gray";
      }
      if (type === "status") {
        if (val.includes("done") || val.includes("submitted")) return "green";
        if (val.includes("on going")) return "orange";
        return "gray";
      }
      if (type === "category") {
        if (val.includes("capstone")) return "lilac";
        if (val.includes("faculty")) return "salmon";
        if (val.includes("program")) return "sand";
        if (val.includes("soa")) return "mint";
        if (val.includes("osd")) return "sand";
        return "gray";
      }
      return "gray";
    }

    function createSelectCell(value, options, type, editable, onChange) {
      const select = document.createElement("select");
      select.className = `chip-select ${getChipClass(value, type)}`;
      select.disabled = !editable;
      for (const opt of options) {
        const option = document.createElement("option");
        option.value = opt;
        option.textContent = opt;
        if (opt === value) option.selected = true;
        select.append(option);
      }
      select.addEventListener("change", (e) => {
        select.className = `chip-select ${getChipClass(e.target.value, type)}`;
        onChange(e.target.value);
      });
      return select;
    }

    function createEditableCell(value, editable, onChange, isId = false) {
      const cell = document.createElement("div");
      cell.contentEditable = editable ? "true" : "false";
      cell.className = `editable${isId ? " id" : ""}${editable ? "" : " readonly"}`;
      cell.textContent = value || "";
      cell.addEventListener("blur", () => {
        if (editable) onChange(cell.textContent.trim());
      });
      return cell;
    }

    function createInputCell(value, placeholder, onInput) {
      const input = document.createElement("input");
      input.className = "input-field";
      input.type = "text";
      input.value = value || "";
      input.placeholder = placeholder || "";
      input.addEventListener("input", (e) => onInput(e.target.value));
      return input;
    }

    function createInputSelect(value, options, type, onChange) {
      const select = document.createElement("select");
      select.className = `chip-select ${getChipClass(value, type)}`;
      for (const opt of options) {
        const option = document.createElement("option");
        option.value = opt;
        option.textContent = opt;
        if (opt === value) option.selected = true;
        select.append(option);
      }
      select.addEventListener("change", (e) => {
        select.className = `chip-select ${getChipClass(e.target.value, type)}`;
        onChange(e.target.value);
      });
      return select;
    }

    function renderRows(data) {
      taskBody.innerHTML = "";

      const newRow = document.createElement("tr");

      const newIdCell = document.createElement("td");
      newIdCell.dataset.label = "Task ID";
      newIdCell.append(createInputCell(newTask.task_id, "BatStateU010", (v) => { newTask.task_id = v; }));
      newRow.append(newIdCell);

      const newNameCell = document.createElement("td");
      newNameCell.dataset.label = "Task Name";
      newNameCell.append(createInputCell(newTask.name, "Task name", (v) => { newTask.name = v; }));
      newRow.append(newNameCell);

      const newCatCell = document.createElement("td");
      newCatCell.dataset.label = "Category";
      newCatCell.append(createInputSelect(newTask.category, categoryOptions, "category", (v) => { newTask.category = v; }));
      newRow.append(newCatCell);

      const newPriorityCell = document.createElement("td");
      newPriorityCell.dataset.label = "Priority";
      newPriorityCell.append(createInputSelect(newTask.priority, priorityOptions, "priority", (v) => { newTask.priority = v; }));
      newRow.append(newPriorityCell);

      const newStatusCell = document.createElement("td");
      newStatusCell.dataset.label = "Status";
      newStatusCell.append(createInputSelect(newTask.status, statusOptions, "status", (v) => { newTask.status = v; }));
      newRow.append(newStatusCell);

      const newActionsCell = document.createElement("td");
      newActionsCell.dataset.label = "Actions";
      newActionsCell.className = "sticky-actions";
      const newActions = document.createElement("div");
      newActions.className = "actions";
      const detailsBtn = document.createElement("button");
      detailsBtn.className = "action-btn";
      detailsBtn.textContent = "Details";
      detailsBtn.addEventListener("click", () => openNewTaskModal());
      const addBtn = document.createElement("button");
      addBtn.className = "action-btn primary";
      addBtn.textContent = "Add Task";
      addBtn.addEventListener("click", async () => {
        try {
          const created = await createTask(newTask);
          tasks.unshift(created);
          newTask = createEmptyTask();
          setLastUpdated();
          refreshFilterOptions();
          applyFilters();
        } catch (error) {
          alert("Failed to add task. Please try again.");
        }
      });
      newActions.append(detailsBtn, addBtn);
      newActionsCell.append(newActions);
      newRow.append(newActionsCell);

      taskBody.append(newRow);

      data.forEach((task) => {
        const row = document.createElement("tr");
        const editable = task.id === editingId;
        const deadlineStatus = getDeadlineStatus(task);
        if (deadlineStatus === "overdue") row.classList.add("row-overdue");
        if (deadlineStatus === "due-soon") row.classList.add("row-due-soon");

        const idCell = document.createElement("td");
        idCell.dataset.label = "Task ID";
        idCell.append(createEditableCell(task.task_id, editable, (v) => { task.task_id = v; }, true));
        row.append(idCell);

        const nameCell = document.createElement("td");
        nameCell.dataset.label = "Task Name";
        const nameWrapper = document.createElement("div");
        nameWrapper.append(createEditableCell(task.name, editable, (v) => { task.name = v; }));
        if (deadlineStatus === "overdue") {
          const badge = document.createElement("span");
          badge.className = "deadline-badge";
          badge.textContent = "Overdue";
          nameWrapper.append(badge);
        }
        if (deadlineStatus === "due-soon") {
          const badge = document.createElement("span");
          badge.className = "deadline-badge due-soon";
          badge.textContent = "Due Soon";
          nameWrapper.append(badge);
        }
        nameCell.append(nameWrapper);
        row.append(nameCell);

        const catCell = document.createElement("td");
        catCell.dataset.label = "Category";
        catCell.append(createSelectCell(task.category, categoryOptions, "category", editable, (v) => { task.category = v; }));
        row.append(catCell);

        const priorityCell = document.createElement("td");
        priorityCell.dataset.label = "Priority";
        priorityCell.append(createSelectCell(task.priority, priorityOptions, "priority", editable, (v) => { task.priority = v; }));
        row.append(priorityCell);

        const statusCell = document.createElement("td");
        statusCell.dataset.label = "Status";
        statusCell.append(createSelectCell(task.status, statusOptions, "status", editable, (v) => { task.status = v; }));
        row.append(statusCell);

        const actionsCell = document.createElement("td");
        actionsCell.dataset.label = "Actions";
        actionsCell.className = "sticky-actions";
        const actions = document.createElement("div");
        actions.className = "actions";

        const viewBtn = document.createElement("button");
        viewBtn.className = "action-btn";
        viewBtn.textContent = "View";
        viewBtn.addEventListener("click", () => openDetailModal(task));

        const editBtn = document.createElement("button");
        editBtn.className = "action-btn";
        editBtn.textContent = editable ? "Editing" : "Update";
        editBtn.disabled = editable;
        editBtn.addEventListener("click", () => {
          editingId = task.id;
          applyFilters();
        });

        const saveBtn = document.createElement("button");
        saveBtn.className = "action-btn primary";
        saveBtn.textContent = "Save";
        saveBtn.disabled = !editable;
        saveBtn.addEventListener("click", async () => {
          try {
            const updated = await updateTask(task.id, task);
            tasks = tasks.map((t) => (t.id === updated.id ? updated : t));
            editingId = null;
            setLastUpdated();
            refreshFilterOptions();
            applyFilters();
          } catch (error) {
            alert("Failed to save changes. Please try again.");
          }
        });

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "action-btn";
        deleteBtn.textContent = "Delete";
        deleteBtn.addEventListener("click", async () => {
          if (!confirm("Delete this task? This cannot be undone.")) return;
          try {
            await deleteTask(task.id);
            tasks = tasks.filter((t) => t.id !== task.id);
            if (editingId === task.id) editingId = null;
            setLastUpdated();
            refreshFilterOptions();
            applyFilters();
          } catch (error) {
            alert("Failed to delete task. Please try again.");
          }
        });

        actions.append(viewBtn, editBtn, saveBtn, deleteBtn);
        actionsCell.append(actions);
        row.append(actionsCell);

        taskBody.append(row);
      });

      updateDeadlineStats(data);
    }

    function applyFilters() {
      const q = searchInput.value.trim().toLowerCase();
      const cat = filterCategory.value;
      const pri = filterPriority.value;
      const stat = filterStatus.value;
      const startDateFilter = filterStartDate.value;

      const filtered = tasks.filter((t) => {
        const statusText = String(t.status || "").toLowerCase();
        if (statusText.includes("done") || statusText.includes("submitted")) return false;
        const haystack = `${t.task_id} ${t.name} ${t.description} ${t.remarks}`.toLowerCase();
        if (q && !haystack.includes(q)) return false;
        if (cat && t.category !== cat) return false;
        if (pri && t.priority !== pri) return false;
        if (stat && t.status !== stat) return false;
        if (startDateFilter && toDateInputValue(t.start_date) !== startDateFilter) return false;
        return true;
      });

      renderRows(filtered);
    }

    searchInput.addEventListener("input", applyFilters);
    filterCategory.addEventListener("change", applyFilters);
    filterPriority.addEventListener("change", applyFilters);
    filterStatus.addEventListener("change", applyFilters);
    filterStartDate.addEventListener("change", applyFilters);
    compactToggle.addEventListener("click", () => {
      isCompact = !isCompact;
      applyCompactState();
    });

    function renderDetailModal(task, editable) {
      detailBody.innerHTML = "";
      const fields = [
        ["Task ID", "task_id"],
        ["Task Name", "name"],
        ["Task Description", "description"],
        ["Category", "category"],
        ["Priority", "priority"],
        ["Status", "status"],
        ["Start Date", "start_date"],
        ["Due Date", "due_date"],
        ["Estimated Time (hrs)", "est_time"],
        ["Actual Time (hrs)", "act_time"],
        ["Remarks", "remarks"]
      ];

      fields.forEach(([label, key]) => {
        const div = document.createElement("div");
        div.className = "detail";
        const value = task[key] || "";
        if (editable) {
          div.innerHTML = `<span>${label}</span>`;
          if (key === "category" || key === "priority" || key === "status") {
            const options = key === "category" ? categoryOptions : key === "priority" ? priorityOptions : statusOptions;
            const select = document.createElement("select");
            select.className = "input-field";
            options.forEach((opt) => {
              const option = document.createElement("option");
              option.value = opt;
              option.textContent = opt;
              if (opt === value) option.selected = true;
              select.append(option);
            });
            select.addEventListener("change", (e) => { modalTask[key] = e.target.value; });
            div.append(select);
          } else if (key === "start_date" || key === "due_date") {
            const input = document.createElement("input");
            input.className = "input-field";
            input.type = "date";
            input.value = toDateInputValue(value);
            input.addEventListener("input", (e) => { modalTask[key] = e.target.value; });
            div.append(input);
          } else {
            const input = document.createElement("input");
            input.className = "input-field";
            input.value = value;
            input.addEventListener("input", (e) => { modalTask[key] = e.target.value; });
            div.append(input);
          }
        } else {
          div.innerHTML = `<span>${label}</span>${value || "-"}`;
        }
        detailBody.append(div);
      });
    }

    function openDetailModal(task, mode = "view") {
      modalTask = { ...task };
      modalMode = mode;
      detailSubtitle.textContent = task.task_id ? `Task ID: ${task.task_id}` : "Task Details";
      renderDetailModal(modalTask, modalMode === "edit");
      editModalBtn.style.display = mode === "view" ? "inline-flex" : "none";
      saveModalBtn.style.display = mode === "edit" ? "inline-flex" : "none";
      detailModal.classList.add("open");
      detailModal.setAttribute("aria-hidden", "false");
    }

    function openNewTaskModal() {
      modalTask = newTask;
      modalMode = "new";
      detailSubtitle.textContent = "New Task Details";
      renderDetailModal(modalTask, true);
      editModalBtn.style.display = "none";
      saveModalBtn.style.display = "inline-flex";
      detailModal.classList.add("open");
      detailModal.setAttribute("aria-hidden", "false");
    }

    function closeDetailModal() {
      detailModal.classList.remove("open");
      detailModal.setAttribute("aria-hidden", "true");
    }

    closeModalBtn.addEventListener("click", closeDetailModal);
    closeModalBtnBottom.addEventListener("click", closeDetailModal);
    detailModal.addEventListener("click", (e) => {
      if (e.target === detailModal) closeDetailModal();
    });

    editModalBtn.addEventListener("click", () => {
      modalMode = "edit";
      renderDetailModal(modalTask, true);
      editModalBtn.style.display = "none";
      saveModalBtn.style.display = "inline-flex";
    });

    saveModalBtn.addEventListener("click", async () => {
      if (!modalTask) return;
      if (modalMode === "new") {
        closeDetailModal();
        return;
      }
      try {
        const updated = await updateTask(modalTask.id, modalTask);
        tasks = tasks.map((t) => (t.id === updated.id ? updated : t));
        setLastUpdated();
        refreshFilterOptions();
        applyFilters();
        closeDetailModal();
      } catch (error) {
        alert("Failed to save details. Please try again.");
      }
    });

    resetBtn.addEventListener("click", () => {
      editingId = null;
      searchInput.value = "";
      filterCategory.value = "";
      filterPriority.value = "";
      filterStatus.value = "";
      filterStartDate.value = "";
      fetchTasks();
    });

    isCompact = JSON.parse(localStorage.getItem("compactView") || "false");
    applyCompactState();
    fetchTasks();
  </script>
</body>
</html>
